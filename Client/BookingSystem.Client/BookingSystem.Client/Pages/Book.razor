@page "/book"
@page "/"
@attribute [Authorize] // فقط کاربران لاگین شده دسترسی دارند
@inject HttpClient Http
@inject ISnackbar Snackbar
@inject NavigationManager NavManager

@using BookingSystem.Client.Models
@using System.Net.Http.Json
@using Microsoft.AspNetCore.Authorization

<MudText Typo="Typo.h4" Class="mb-4">رزرو نوبت جدید</MudText>
<MudGrid>
    <MudItem xs="12" md="6">
        <MudCard>
            <MudCardHeader>
                <MudText Typo="Typo.h6">انتخاب سرویس و تاریخ</MudText>
            </MudCardHeader>
            <MudCardContent>
                <MudSelect T="ServiceDto" Label="سرویس مورد نظر"
                           @bind-Value="SelectedService"
                           @bind-Value:after="OnSelectionChanged"
                           Clearable="true" Required="true">
                    @foreach (var service in Services)
                    {
                        <MudSelectItem Value="@service">@service.Name</MudSelectItem>
                    }
                </MudSelect>
                
                <MudDatePicker Label="تاریخ نوبت"
                               @bind-Date="SelectedDate"
                               @bind-Date:after="OnSelectionChanged"
                               MinDate="@DateTime.Today"
                               Class="mt-3" Required="true" />

                <MudSwitch T="bool" @bind-Checked="_payOnline" Color="Color.Primary" Class="mt-4">
                    <ChildContent>
                        <MudText Typo="Typo.body2">پرداخت آنلاین هنگام رزرو</MudText>
                    </ChildContent>
                </MudSwitch>
                <MudText Typo="Typo.caption" Class="ml-4">
                    در صورت انتخاب، پس از ثبت رزرو پرداخت شبیه‌سازی شده و وضعیت آن به «پرداخت شده» تغییر می‌کند.
                </MudText>
                
                @if (SelectedService != null)
                {
                    <MudText Class="mt-3" Typo="Typo.subtitle2">
                        مدت زمان: @SelectedService.DurationMinutes دقیقه
                    </MudText>
                }
            </MudCardContent>
        </MudCard>
    </MudItem>

    <MudItem xs="12" md="6">
        <MudCard>
            <MudCardHeader>
                <MudText Typo="Typo.h6">انتخاب ساعت (سانس‌های خالی)</MudText>
            </MudCardHeader>
            <MudCardContent>
                @if (Slots.Any())
                {
                    <MudList T="TimeSlotDto" Clickable="true" Dense="true">
                        @foreach (var slot in Slots)
                        {
                            <MudListItem T="TimeSlotDto"
                                         Icon="@Icons.Material.Filled.AccessTime"
                                         Disabled="_isBooking"
                                         OnClick="@(() => BookSlot(slot))">
                                <span style="font-weight: bold;">@slot.DisplayTime</span> - @slot.EndTime.ToShortTimeString()
                            </MudListItem>
                        }
                    </MudList>
                }
                else if (SelectedService != null && SelectedDate.HasValue)
                {
                    <MudAlert Severity="Severity.Info">وقت خالی در این تاریخ وجود ندارد.</MudAlert>
                }
                else
                {
                    <MudText Typo="Typo.body2">لطفا سرویس و تاریخ را انتخاب کنید تا زمان‌های خالی نمایش داده شوند.</MudText>
                }
            </MudCardContent>
        </MudCard>
    </MudItem>

    <MudItem xs="12" md="6">
        <MudCard>
            <MudCardHeader>
                <MudText Typo="Typo.h6">پرداخت</MudText>
            </MudCardHeader>
            <MudCardContent>
                @if (SelectedService != null)
                {
                    <MudText Typo="Typo.subtitle1" Class="mb-2">
                        مبلغ سرویس: @SelectedService.Price.ToString("N0") تومان
                    </MudText>
                }
                else
                {
                    <MudText Typo="Typo.body2" Class="mb-2">
                        برای مشاهده مبلغ، ابتدا سرویس را انتخاب کنید.
                    </MudText>
                }

                <MudSwitch T="bool"
                           @bind-Checked="_payOnline"
                           Color="Color.Primary"
                           Class="mt-2"
                           Label="پرداخت آنلاین بلافاصله بعد از رزرو">
                </MudSwitch>

                @if (_payOnline)
                {
                    <MudAlert Severity="Severity.Info" Elevation="0" Class="mt-3">
                        پس از تایید رزرو، پرداخت به‌صورت خودکار انجام می‌شود و کد رهگیری نمایش داده خواهد شد.
                    </MudAlert>
                }
                else
                {
                    <MudAlert Severity="Severity.Warning" Elevation="0" Class="mt-3">
                        پرداخت آنلاین غیرفعال است. تسویه را در محل انجام دهید.
                    </MudAlert>
                }
            </MudCardContent>
        </MudCard>
    </MudItem>
</MudGrid>

